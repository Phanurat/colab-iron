<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ğŸ“ Change Bio Editor</title>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.0.0/dist/handsontable.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.0.0/dist/handsontable.full.min.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
    }

    .navbar {
      height: 56px;
      background-color: #ffffff;
      display: flex;
      align-items: center;
      padding: 0 20px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar a,
    .navbar button {
      margin-right: 10px;
      padding: 8px 14px;
      font-size: 14px;
      text-decoration: none;
      color: #333;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    button{
      background: none;
    }

    .navbar a:hover,
    .navbar button:hover {
      background-color: #e0e0e0;
    }

    .navbar button {
      font-family: inherit;
    }

    .navbar a {
      display: inline-block;
    }

    .navbar .spacer {
      flex-grow: 1;
    }

    #hot {
      position: absolute;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
    }
  </style>
</head>
<body>

  <div id="toolbar" class="navbar">
    <a href="/">ğŸ  Home</a>
    <button onclick="loadChangeBio()">ğŸ”„ Load Change Bio</button>
    <button onclick="saveChangeBio()">ğŸ’¾ Save</button>
    <a href="/bio-intro">ğŸ“„ Bio Intro</a>
    <a href="/change-city">ğŸ™ï¸ Change City</a>
    <a href="/change-name">ğŸ“ Change Name</a>
    <a href="/switch-bio">ğŸ” Switch Bio</a>
    <a href="/switch-lock">ğŸ”’ Lock</a>
    <a href="/switch-unlock">ğŸ”“ Unlock</a>
    <button><a href="/log">log-info</a></button>
    <div class="spacer"></div>
  </div>


<div id="hot"></div>

<script>
  const hotDiv = document.getElementById("hot");
  let hot;
  let currentHeaders = [];

  async function loadChangeBio() {
    const projects = await fetch('/api/projects').then(r => r.json());

    // STEP 1: à¸«à¸²à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸ˆà¸£à¸´à¸‡à¸ˆà¸²à¸à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œà¸—à¸µà¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    let columns = null;
    for (const p of projects) {
      const res = await fetch(`/api/data/${p}`);
      const data = await res.json();
      if (data.change_bio_table && Array.isArray(data.change_bio_table.columns) && data.change_bio_table.columns.length > 0) {
        columns = data.change_bio_table.columns;
        break;
      }
    }
    if (!columns) {
      columns = ["id", "bio_intro"]; // fallback
    }
    const headers = ["project", ...columns];
    currentHeaders = headers;

    // STEP 2: à¹‚à¸«à¸¥à¸” rows à¸—à¸¸à¸à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ
    const promises = projects.map(async (p) => {
      try {
        const res = await fetch(`/api/data/${p}`);
        const data = await res.json();
        if (data.change_bio_table && Array.isArray(data.change_bio_table.rows)) {
          const rows = data.change_bio_table.rows;
          if (rows.length === 0) {
            return [[p, ...columns.map(() => null)]];
          } else {
            return rows.map(row => [p, ...row]);
          }
        } else {
          return [[p, ...columns.map(() => null)]];
        }
      } catch (e) {
        console.warn(`âŒ error loading ${p}`, e);
        return [[p, ...columns.map(() => null)]];
      }
    });

    const results = await Promise.all(promises);
    const flatRows = results.flat();

    if (hot) hot.destroy();
    hot = new Handsontable(hotDiv, {
      data: flatRows,
      colHeaders: headers,
      rowHeaders: true,
      contextMenu: true,
      manualRowMove: true,
      manualColumnResize: true,
      stretchH: 'last',
      width: '100%',
      height: '100%',
      colWidths: headers.map(h => h === "project" ? 100 : 300),
      licenseKey: 'non-commercial-and-evaluation'
    });
  }

  function saveChangeBio() {
    const allData = hot.getData();
    const grouped = {};
    const columns = currentHeaders.slice(1); // remove project

    for (const row of allData) {
      const project = row[0];
      const values = row.slice(1);
      if (!grouped[project]) grouped[project] = [];
      // à¸‚à¹‰à¸²à¸¡ row à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸£à¸´à¸‡
      if (values.some(v => v !== null && v !== "")) {
        grouped[project].push(values);
      }
    }

    for (const [project, rows] of Object.entries(grouped)) {
      const payload = JSON.stringify({ columns, rows });
      fetch(`/api/update/${project}/change_bio_table`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: payload
      })
      .then(res => res.json())
      .then(msg => console.log(`[âœ“] ${project}`, msg));
    }

    alert("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸—à¸¸à¸à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ");
  }

  window.addEventListener("resize", () => {
    if (hot) hot.render();
  });
</script>

</body>
</html>
