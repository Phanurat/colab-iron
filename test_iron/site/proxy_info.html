<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ğŸ™ï¸ Change Proxy Key Editor</title>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.0.0/dist/handsontable.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.0.0/dist/handsontable.full.min.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
      background-color: #f9f9f9;
      overflow: hidden;
    }
    #toolbar {
      height: 48px;
      background-color: #eaeaea;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 12px;
      border-bottom: 1px solid #ccc;
      box-sizing: border-box;
    }
    #hot {
      position: absolute;
      top: 48px;
      left: 0;
      right: 0;
      bottom: 0;
    }
    button, .btn-link {
      font-size: 14px;
      padding: 6px 12px;
      text-decoration: none;
      border: 1px solid #ccc;
      background-color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-link:hover, button:hover {
      background-color: #ddd;
    }
  </style>
</head>
<body>

<div id="toolbar">
  <a href="/" class="btn-link">ğŸ  Home</a>
  <button onclick="loadChangeProxy()">ğŸ”„ Load Change Proxy</button>   
  <button onclick="saveChangeProxy()">ğŸ’¾ Save</button>
  <a href="/bio-intro" class="btn-link">bio-intro</a>
  <a href="/change-city" class="btn-link">change-city</a>
  <a href="/change-name" class="btn-link">change-name</a>
  <a href="/switch-bio" class="btn-link">switch-bio</a>
  <a href="/switch-lock" class="btn-link">switch-lock</a>
  <a href="/switch-unlock" class="btn-link">switch-unlock</a>
  <a href="/proxy-info" class="btn-link">proxy-info</a>
</div>

<div id="hot"></div>

<script>
  const hotDiv = document.getElementById("hot");
  let hot;
  let currentHeaders = [];

  async function loadChangeProxy() {
    const projects = await fetch('/api/projects').then(r => r.json());

    // STEP 1: à¸«à¸²à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸ˆà¸£à¸´à¸‡
    let columns = null;
    for (const p of projects) {
      const res = await fetch(`/api/data/${p}`);
      const data = await res.json();
      if (data.change_proxy_table && Array.isArray(data.change_proxy_table.columns) && data.change_proxy_table.columns.length > 0) {
        columns = data.change_proxy_table.columns;
        break;
      }
    }
    if (!columns) columns = ["id", "proxy_key"];
    const headers = ["project", ...columns];
    currentHeaders = headers;

    // STEP 2: à¹‚à¸«à¸¥à¸” rows à¸—à¸¸à¸à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ
    const promises = projects.map(async (p) => {
      try {
        const res = await fetch(`/api/data/${p}`);
        const data = await res.json();
        if (data.change_proxy_table && Array.isArray(data.change_proxy_table.rows)) {
          const rows = data.change_proxy_table.rows;
          if (rows.length === 0) {
            return [[p, ...columns.map(() => null)]];
          } else {
            return rows.map(row => [p, ...row]);
          }
        } else {
          return [[p, ...columns.map(() => null)]];
        }
      } catch (e) {
        console.warn(`âŒ error loading ${p}`, e);
        return [[p, ...columns.map(() => null)]];
      }
    });

    const results = await Promise.all(promises);
    const flatRows = results.flat();

    if (hot) hot.destroy();
    hot = new Handsontable(hotDiv, {
      data: flatRows,
      colHeaders: headers,
      rowHeaders: true,
      contextMenu: true,
      manualRowMove: true,
      manualColumnResize: true,
      stretchH: 'last',
      width: '100%',
      height: '100%',
      colWidths: headers.map(h => h === "project" ? 100 : 300),
      licenseKey: 'non-commercial-and-evaluation'
    });
  }

  async function saveChangeProxy() {
    const allData = hot.getData();
    const grouped = {};
    const columns = currentHeaders.slice(1); // remove project

    for (const row of allData) {
      const project = row[0];
      const values = row.slice(1);
      if (!grouped[project]) grouped[project] = [];
      if (values.some(v => v !== null && v !== "")) {
        grouped[project].push(values);
      }
    }

    let failed = [];

    await Promise.all(Object.entries(grouped).map(async ([project, rows]) => {
      const payload = JSON.stringify({ columns, rows });
      try {
        const res = await fetch(`/api/update/${project}/proxy-info`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: payload
        });
        const msg = await res.json();
        if (!res.ok) {
          console.error(`[âœ—] ${project}`, msg);
          failed.push(project);
        } else {
          console.log(`[âœ“] ${project}`, msg);
        }
      } catch (err) {
        console.error(`[âœ—] ${project} ERROR`, err);
        failed.push(project);
      }
    }));

    if (failed.length > 0) {
      alert(`âŒ à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹ƒà¸™à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ:\n${failed.join(", ")}`);
    } else {
      alert("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ proxy_key à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸—à¸¸à¸à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ");
    }
  }

  window.addEventListener("resize", () => {
    if (hot) hot.render();
  });
</script>

</body>
</html>
